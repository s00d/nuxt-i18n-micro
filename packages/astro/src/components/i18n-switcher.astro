---
import type { Locale } from '@i18n-micro/types'
import type { I18nRoutingStrategy } from '../router/types'
import { useI18n } from '../utils'

interface Props {
  class?: string
  activeClass?: string
  customLabels?: Record<string, string>
  [key: string]: unknown
}

const { class: className, activeClass = 'active', customLabels = {}, ...attrs } = Astro.props

const { locale: currentLocale, locales, defaultLocale, getBasePath } = useI18n(Astro)
const localeCodes = locales.map((l: Locale) => l.code)

// Get routing strategy from locals
// @ts-expect-error
const routingStrategy: I18nRoutingStrategy | null = Astro.locals.routingStrategy || null

// Filter out disabled locales
const availableLocales = locales.filter((loc: Locale) => !loc.disabled)

// Find current locale object
const currentLocaleObj = availableLocales.find((loc: Locale) => loc.code === currentLocale)
const currentLocaleLabel = currentLocaleObj
  ? customLabels[currentLocaleObj.code] || currentLocaleObj.displayName || currentLocaleObj.code
  : currentLocale

// Generate locale links
const localeLinks = availableLocales.map((loc: Locale) => {
  const isActive = loc.code === currentLocale
  // Get base path without locale
  const basePath = getBasePath()
  // Generate path with locale
  let switchPath = basePath
  if (routingStrategy?.switchLocalePath) {
    switchPath = routingStrategy.switchLocalePath(basePath, loc.code, localeCodes, defaultLocale)
  } else {
    // Fallback: basic locale switching
    const segments = basePath.split('/').filter(Boolean)
    const firstSegment = segments[0]
    if (firstSegment && localeCodes.includes(firstSegment)) {
      segments.shift()
    }
    if (loc.code !== defaultLocale) {
      segments.unshift(loc.code)
    }
    switchPath = `/${segments.join('/')}`
  }

  const label = customLabels[loc.code] || loc.displayName || loc.code

  return {
    code: loc.code,
    displayName: label,
    path: switchPath,
    isActive,
  }
})

// Generate unique ID for this component instance
const componentId = `i18n-switcher-${Math.random().toString(36).substring(2, 9)}`
---

{localeLinks.length > 0 && (
  <div
    class={`i18n-switcher-wrapper ${className || ''}`}
    data-switcher-id={componentId}
    {...attrs}
  >
    <button
      type="button"
      class="i18n-switcher-button"
      aria-haspopup="true"
      aria-expanded="false"
      data-switcher-button={componentId}
    >
      <span>{currentLocaleLabel}</span>
      <span class="i18n-switcher-icon">â–¼</span>
    </button>

    <ul
      class="i18n-switcher-dropdown"
      data-switcher-dropdown={componentId}
      style="display: none;"
    >
      {localeLinks.map((link) => (
        <li>
          <a
            href={link.path}
            class={link.isActive ? activeClass : ''}
            aria-current={link.isActive ? 'page' : undefined}
            data-locale={link.code}
            data-switcher-link={componentId}
          >
            {link.displayName}
          </a>
        </li>
      ))}
    </ul>
  </div>
)}

<script define:vars={{ componentId, localeLinks }}>
  (function() {
    const wrapper = document.querySelector(`[data-switcher-id="${componentId}"]`)
    if (!wrapper) return

    const button = wrapper.querySelector(`[data-switcher-button="${componentId}"]`)
    const dropdown = wrapper.querySelector(`[data-switcher-dropdown="${componentId}"]`)
    const icon = wrapper.querySelector('.i18n-switcher-icon')

    if (!button || !dropdown) return

    let isOpen = false

    const toggleDropdown = (event) => {
      if (event) {
        event.stopPropagation()
        event.preventDefault()
      }
      isOpen = !isOpen
      dropdown.style.display = isOpen ? 'block' : 'none'
      button.setAttribute('aria-expanded', String(isOpen))
      if (icon) {
        icon.style.transform = isOpen ? 'rotate(180deg)' : 'rotate(0deg)'
      }
    }

    const closeDropdown = () => {
      if (isOpen) {
        isOpen = false
        dropdown.style.display = 'none'
        button.setAttribute('aria-expanded', 'false')
        if (icon) {
          icon.style.transform = 'rotate(0deg)'
        }
      }
    }

    button.addEventListener('click', toggleDropdown)

    // Close on outside click
    const handleClickOutside = (event) => {
      const target = event.target
      if (!target || !wrapper.contains(target)) {
        closeDropdown()
      }
    }

    document.addEventListener('click', handleClickOutside)

    // Close on Escape key
    const handleEscape = (event) => {
      if (event.key === 'Escape' && isOpen) {
        closeDropdown()
      }
    }

    document.addEventListener('keydown', handleEscape)

    // Handle locale link clicks
    const links = wrapper.querySelectorAll(`[data-switcher-link="${componentId}"]`)
    links.forEach((link) => {
      link.addEventListener('click', () => {
        // Let the link navigate naturally, but close dropdown
        closeDropdown()
      })
    })
  })()
</script>

<style>
  .i18n-switcher-wrapper {
    position: relative;
    display: inline-block;
    vertical-align: middle;
  }

  .i18n-switcher-button {
    padding: 4px 12px;
    font-size: 16px;
    cursor: pointer;
    background-color: #fff;
    border: 1px solid #333;
    transition: background-color 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }

  .i18n-switcher-button:hover {
    background-color: #f0f0f0;
  }

  .i18n-switcher-icon {
    margin-left: 0;
    display: inline-block;
    transition: transform 0.3s ease;
    font-size: 12px;
  }

  .i18n-switcher-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    background-color: #fff;
    border: 1px solid #333;
    list-style: none;
    padding: 0;
    margin: 4px 0 0 0;
    min-width: 150px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }

  .i18n-switcher-dropdown li {
    margin: 0;
    padding: 0;
  }

  .i18n-switcher-dropdown a {
    display: block;
    padding: 8px 12px;
    color: #333;
    text-decoration: none;
    transition: background-color 0.3s ease;
    cursor: pointer;
  }

  .i18n-switcher-dropdown a:hover {
    background-color: #f0f0f0;
  }

  .i18n-switcher-dropdown a.active {
    font-weight: bold;
    color: #007bff;
    background-color: #f0f0f0;
  }
</style>

