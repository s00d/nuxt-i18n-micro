import { globby } from 'globby'
import { readFileSync, writeFileSync, mkdirSync } from 'node:fs'
import { resolve, dirname } from 'node:path'
import { flattenKeys } from './parser'

export interface GeneratorOptions {
  srcDir: string
  translationDir: string
  outputFile?: string // Куда класть d.ts файл
}

/**
 * Генерирует строку с TypeScript типами для ключей переводов.
 * Не записывает файл, только возвращает содержимое.
 *
 * @param options - Опции генератора
 * @returns Строка с содержимым .d.ts файла
 */
export async function getTypesString(options: GeneratorOptions): Promise<string> {
  const localesDir = resolve(options.srcDir, options.translationDir)

  // Ищем все json файлы в папке переводов (включая подпапки pages)
  const files = await globby('**/*.json', {
    cwd: localesDir,
    absolute: true,
    ignore: ['node_modules/**', 'dist/**', '.nuxt/**'],
  })

  const allKeys = new Set<string>()

  for (const file of files) {
    try {
      const content = JSON.parse(readFileSync(file, 'utf-8'))
      const keys = flattenKeys(content)
      for (const k of keys) {
        allKeys.add(k)
      }
    }
    catch (e) {
      console.warn(`[i18n-types] Failed to parse ${file}:`, e)
    }
  }

  // Генерация контента файла .d.ts
  // Важно: мы расширяем модуль '@i18n-micro/types'
  const keysContent = Array.from(allKeys)
    .sort()
    .map(key => `    '${key}': string;`)
    .join('\n')

  return `/* eslint-disable */
/* prettier-ignore */
// @ts-nocheck
// Generated by @i18n-micro/types-generator
// DO NOT EDIT THIS FILE MANUALLY

import '@i18n-micro/types';

declare module '@i18n-micro/types' {
  export interface DefineLocaleMessage {
${keysContent}
  }
}
`
}

/**
 * Генерирует TypeScript типы для ключей переводов из JSON файлов.
 * Записывает результат в файл.
 *
 * @param options - Опции генератора
 * @returns Путь к сгенерированному файлу
 */
export async function generateTypes(options: GeneratorOptions): Promise<string> {
  const fileContent = await getTypesString(options)

  // Определяем путь для записи (по умолчанию в корень или .nuxt)
  const outputPath = options.outputFile || resolve(options.srcDir, 'i18n-micro.d.ts')

  // Создаем директорию если нет
  const outputDir = dirname(outputPath)
  try {
    mkdirSync(outputDir, { recursive: true })
  }
  catch {
    // Директория уже существует
  }

  writeFileSync(outputPath, fileContent, 'utf-8')

  return outputPath
}
